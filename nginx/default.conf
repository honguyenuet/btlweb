# ============================================
# Nginx Reverse Proxy + Load Balancer + Rate Limiting
# For Docker Compose: Next.js + Laravel
# ============================================

# ========================
# Rate limiting zones
# ========================
limit_req_zone $binary_remote_addr zone=general_zone:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=api_zone:10m rate=20r/m;
limit_conn_zone $binary_remote_addr zone=addr:10m;

# Allow CORS only from known origins (adjust the regex to match your dev/prod origins)
# This map sets $cors_allow_origin to the incoming Origin when it matches, otherwise empty
map $http_origin $cors_allow_origin {
    default "";
    ~^https?://(localhost(?::[0-9]+)?|127\.0\.0\.1(?::[0-9]+)?|tinhnguyen\.com)$ $http_origin;
}

# Route based on Accept header for /admin/, /manager/, /user/ paths
# If Accept contains application/json → backend, else → frontend
map $http_accept $upstream_target {
    default "frontend_upstream";
    ~*application/json "backend_upstream";
}

# ========================
# Upstreams
# ========================
# Frontend (Next.js)
upstream frontend_upstream {
    server nextjs_app:3000;  # chú ý dùng tên service trong Docker Compose
}

# Backend (Laravel)
upstream backend_upstream {
    least_conn;
    server laravel_app:8080 max_fails=3 fail_timeout=30s;
    keepalive 32;
}

# ========================
# Server config
# ========================
server {
    listen 80;
    server_name tinhnguyen.com;

    # Common CORS response headers (will be sent for responses where $cors_allow_origin is set)
    add_header Access-Control-Allow-Origin $cors_allow_origin always;
    add_header Access-Control-Allow-Credentials "true" always;
    add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH" always;
    add_header Access-Control-Allow-Headers "Authorization,Origin, X-Requested-With, Content-Type, Accept" always;

    location / {
        # Default: serve from frontend (Next.js)
        # This handles all page routes: /admin/dashboard, /manager/events, /user/profile, etc.
        proxy_pass http://frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
    }

    # Next.js internal static
    location /_next/ {
        proxy_pass http://frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /_next/static/ {
        proxy_pass http://frontend_upstream/_next/static/;
        proxy_set_header Host $host;
    }

    location /api/ {
        # Rate limiting per IP for API endpoints
        # - api_zone: configured above (20 requests per minute by default)
        # - burst allows short spikes, nodelay enforces strict limit
        limit_req zone=api_zone burst=30 nodelay;
        # Limit concurrent connections per IP
        limit_conn addr 10;

        # Handle CORS preflight requests quickly without proxying to backend
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $cors_allow_origin always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Origin, X-Requested-With, Content-Type, Accept" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        # Rewrite to remove /api prefix before proxying to backend
        # /api/login → /api/login (Laravel expects /api/ in routes)
        # If Laravel routes don't have /api prefix, use: rewrite ^/api/(.*) /$1 break;
        
        # Proxy to laravel backend using upstream for load balancing
        proxy_pass http://backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Scheme $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }

    # Backend API routes (admin, manager, user)
    # Route based on Accept header:
    # - Accept: application/json → Backend API
    # - Accept: text/html → Frontend page
    location ~ ^/(admin|manager|user)/ {
        # Use map $upstream_target defined above (based on Accept header)
        proxy_pass http://$upstream_target;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Scheme $scheme;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header Connection "";
        
        # For Next.js SSR
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_cache_bypass $http_upgrade;
        
        # Rate limiting for API calls
        limit_req zone=api_zone burst=30 nodelay;
        limit_conn addr 10;

        # Handle CORS preflight
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $cors_allow_origin always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Origin, X-Requested-With, Content-Type, Accept" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }
    }

    # REMOVED: /admin/, /manager/, /user/ locations
    # These are Next.js page routes (frontend), not API endpoints
    # Backend API should use /api/admin/, /api/manager/, /api/user/ instead

    # Laravel API
    # location /api/ {
    #     proxy_pass http://backend:8080;
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }


    # ========================
    # Security headers
    # ========================
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header Referrer-Policy "no-referrer-when-downgrade" always;
}

# ========================
# Backend API Server (port 8080)
# ========================
server {
    listen 8080;
    server_name localhost;

    # Proxy all requests to backend
    location / {
        # Handle OPTIONS preflight
        if ($request_method = 'OPTIONS') {
            add_header Access-Control-Allow-Origin $cors_allow_origin always;
            add_header Access-Control-Allow-Credentials "true" always;
            add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH" always;
            add_header Access-Control-Allow-Headers "Authorization,Origin, X-Requested-With, Content-Type, Accept" always;
            add_header Content-Length 0;
            add_header Content-Type text/plain;
            return 204;
        }

        # Rate limiting for backend API
        limit_req zone=api_zone burst=30 nodelay;
        limit_conn addr 10;

        # CORS headers
        add_header Access-Control-Allow-Origin $cors_allow_origin always;
        add_header Access-Control-Allow-Credentials "true" always;
        add_header Access-Control-Allow-Methods "GET, POST, OPTIONS, PUT, DELETE, PATCH" always;
        add_header Access-Control-Allow-Headers "Authorization,Origin, X-Requested-With, Content-Type, Accept" always;

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header Referrer-Policy "no-referrer-when-downgrade" always;

        proxy_pass http://backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Connection "";
    }
}
