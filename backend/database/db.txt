-- 1. USERS 
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    phone VARCHAR(20),
    address VARCHAR(255),
    role VARCHAR(50) DEFAULT 'user',
    image VARCHAR(255),
    status VARCHAR(50) DEFAULT 'active',
    addressCard VARCHAR(255),
    email_verified_at TIMESTAMP NULL,
    remember_token VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);


-- 2. EVENTS
CREATE TABLE events (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    image VARCHAR(255),
    address VARCHAR(255),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    author_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(50) DEFAULT 'upcoming',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. POSTS
CREATE TABLE posts (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    image VARCHAR(255),
    address VARCHAR(255),
    start_time TIMESTAMP,
    end_time TIMESTAMP,
    author_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    status VARCHAR(50) DEFAULT 'active',
    likes INT,
    comments INT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
    channel_id INT REFERENCES channel(id) ON DELETE CASCADE,
);

-- 4. COMMENTS
CREATE TABLE comments (
    id BIGSERIAL PRIMARY KEY,
    content TEXT NOT NULL,
    author_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    post_id BIGINT REFERENCES posts(id) ON DELETE CASCADE,
    event_id BIGINT REFERENCES events(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 5. CHANNELS
CREATE TABLE channels (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    event_id BIGINT REFERENCES events(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 6. MESSAGES
CREATE TABLE messages (
    id BIGSERIAL PRIMARY KEY,
    sender_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    channel_id BIGINT NOT NULL REFERENCES channels(id) ON DELETE CASCADE,
    content TEXT,
    sent_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 7. EVENT MANAGEMENTS
CREATE TABLE event_managements (
    id BIGSERIAL PRIMARY KEY,
    event_id BIGINT NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    role VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 8. JOIN EVENTS
CREATE TABLE join_events (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    event_id BIGINT NOT NULL REFERENCES events(id) ON DELETE CASCADE,
    status VARCHAR(50),
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 9. NOTIS (Th√¥ng b√°o)
CREATE TABLE notis (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(255),
    message TEXT,
    sender_id BIGINT REFERENCES users(id) ON DELETE CASCADE,
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 10. LIKES
CREATE TABLE likes (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    post_id BIGINT REFERENCES posts(id) ON DELETE CASCADE,
    event_id BIGINT REFERENCES events(id) ON DELETE CASCADE,
    status VARCHAR(50),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    -- Constraint: M·ªôt user ch·ªâ c√≥ 1 like cho m·ªói post
    CONSTRAINT unique_user_post UNIQUE (user_id, post_id) WHERE post_id IS NOT NULL,
    -- Constraint: M·ªôt user ch·ªâ c√≥ 1 like cho m·ªói event
    CONSTRAINT unique_user_event UNIQUE (user_id, event_id) WHERE event_id IS NOT NULL
);


INSERT INTO users (id, name, email, password, created_at, updated_at)
VALUES
(1, 'Nguy·ªÖn VƒÉn A', 'vana@example.com', '123456', NOW(), NOW()),
(2, 'Tr·∫ßn Th·ªã B', 'thib@example.com', '123456', NOW(), NOW()),
(3, 'L√™ VƒÉn C', 'vanc@example.com', '123456', NOW(), NOW());


INSERT INTO posts (title, content, image, address, start_time, end_time, author_id, status)
VALUES
(
    'Tr·ªìng c√¢y xanh - V√¨ m√¥i tr∆∞·ªùng s·∫°ch',
    'üå± C√πng nhau tr·ªìng c√¢y xanh t·∫°i C√¥ng vi√™n Tao ƒê√†n! H√£y tham gia v·ªõi ch√∫ng m√¨nh ƒë·ªÉ g√≥p ph·∫ßn l√†m xanh th√†nh ph·ªë. M·ªói c√°i c√¢y nh·ªè h√¥m nay s·∫Ω l√† t·∫•m b√≥ng m√°t cho t∆∞∆°ng lai! üå≥',
    'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?w=600&h=400&fit=crop',
    'C√¥ng vi√™n Tao ƒê√†n, Q.1',
    '2025-10-15 07:00:00',
    '2025-10-15 11:00:00',
    1,
    'active'
),
(
    'D·∫°y h·ªçc cho tr·∫ª em v√πng cao',
    'üìö Ch∆∞∆°ng tr√¨nh d·∫°y h·ªçc mi·ªÖn ph√≠ cho tr·∫ª em v√πng cao ƒëang c·∫ßn th√™m t√¨nh nguy·ªán vi√™n! N·∫øu b·∫°n c√≥ ki·∫øn th·ª©c v√† t√¨nh y√™u v·ªõi tr·∫ª em, h√£y tham gia c√πng ch√∫ng m√¨nh nh√©! ‚ù§Ô∏è',
    'https://images.unsplash.com/photo-1503676260728-1c00da094a0b?w=600&h=400&fit=crop',
    'Sapa, L√†o Cai',
    '2025-10-20 00:00:00',
    '2025-10-22 23:59:00',
    2,
    'active'
),
(
    'N·∫•u c∆°m t·ª´ thi·ªán cu·ªëi tu·∫ßn',
    'üç≤ N·∫•u c∆°m t·ª´ thi·ªán cho ng∆∞·ªùi v√¥ gia c∆∞! C√πng nhau mang ƒë·∫øn nh·ªØng b·ªØa ƒÉn ·∫•m √°p v√† t√¨nh ng∆∞·ªùi ƒë·∫øn v·ªõi nh·ªØng ho√†n c·∫£nh kh√≥ khƒÉn trong th√†nh ph·ªë. M·ªçi ng∆∞·ªùi h√£y tham gia nh√©! ü§ù',
    'https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?w=600&h=400&fit=crop',
    'Ch√πa Vƒ©nh Nghi√™m, Q.3',
    '2025-10-14 16:00:00',
    '2025-10-14 20:00:00',
    3,
    'active'
);

